# 账号系统数据库配置

## 概述

账号系统需要两个数据表：
1. `user_accounts` - 存储用户账号信息
2. `user_game_data` - 存储用户游戏数据

## 1. 创建 user_accounts 表

```sql
-- 创建用户账号表
CREATE TABLE user_accounts (
  id BIGSERIAL PRIMARY KEY,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL, -- 密码哈希（SHA-256）
  player_name TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);
```

### 如果表已存在，需要添加密码字段

如果之前已经创建了 `user_accounts` 表但没有 `password_hash` 字段，需要执行以下 SQL 添加：

```sql
-- 添加密码哈希字段（允许为空，兼容旧数据）
ALTER TABLE user_accounts 
ADD COLUMN IF NOT EXISTS password_hash TEXT;

-- 如果需要将字段设为必填（新注册的用户必须有密码）
-- 注意：这会导致没有密码的旧账号无法登录，建议先迁移数据
-- ALTER TABLE user_accounts ALTER COLUMN password_hash SET NOT NULL;
```

-- 创建索引
CREATE INDEX idx_user_accounts_username ON user_accounts(username);

-- 启用行级安全
ALTER TABLE user_accounts ENABLE ROW LEVEL SECURITY;

-- 允许公开访问（读取和插入）
CREATE POLICY "Allow public read" ON user_accounts 
  FOR SELECT USING (true);

CREATE POLICY "Allow public insert" ON user_accounts 
  FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow public update" ON user_accounts 
  FOR UPDATE USING (true);
```

## 2. 创建 user_game_data 表

```sql
-- 创建用户游戏数据表
CREATE TABLE user_game_data (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES user_accounts(id) ON DELETE CASCADE,
  coins INTEGER NOT NULL DEFAULT 0,
  total_stars INTEGER NOT NULL DEFAULT 0,
  level_progress TEXT NOT NULL DEFAULT '[]', -- JSON字符串
  owned_characters TEXT NOT NULL DEFAULT '["mage_307"]', -- JSON字符串
  current_character TEXT NOT NULL DEFAULT 'mage_307',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  UNIQUE(user_id)
);

-- 创建索引
CREATE INDEX idx_user_game_data_user_id ON user_game_data(user_id);

-- 启用行级安全
ALTER TABLE user_game_data ENABLE ROW LEVEL SECURITY;

-- 允许公开访问（读取、插入、更新）
CREATE POLICY "Allow public read" ON user_game_data 
  FOR SELECT USING (true);

CREATE POLICY "Allow public insert" ON user_game_data 
  FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow public update" ON user_game_data 
  FOR UPDATE USING (true);
```

## 3. 注意事项

### 安全性
- 密码使用 SHA-256 哈希存储（前端加密）
- 登录时验证密码哈希
- 密码强度验证：至少4个字符，最多50个字符
- 生产环境建议：
  - 使用 Supabase Auth（推荐，更安全）
  - 或使用后端服务进行 bcrypt 加密
  - 添加登录尝试限制
  - 使用 HTTPS
  - 实现 JWT 认证

### 数据同步
- 游戏数据会同时保存到本地（localStorage）和服务器
- 离线模式下使用本地数据
- 在线时优先从服务器加载数据

### 离线模式
- 当网络不可用或 Supabase 未配置时，进入离线模式
- 离线模式下：
  - 无法登录/注册
  - 无法同步数据到服务器
  - 排行榜等功能不可用
  - 使用本地存储的数据

## 4. 测试

1. 注册新账号
2. 登录账号
3. 测试自动登录（刷新页面）
4. 测试离线模式（断开网络）
5. 测试数据同步（修改数据后检查服务器）

